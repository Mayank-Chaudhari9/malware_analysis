#include <stdio.h>
#include <stdlib.h>
#include <sys/time.h>
#include "opcodeFile.h"
#include "trie.h"
#include "naiveOperations.h"
#include "logger.h"
#define NUM_GROUPS 100
#ifndef NUM_FEATURES
#define NUM_FEATURES 20
#endif
#ifndef EQUAL_NUM_FILES
#define EQUAL_NUM_FILES 0
#endif
#define NUM_CLASSES 2
int main(int argc, char**argv)
{
    if( argc < 4 )
    {
        printf("Usage:  ./main.out <opcode_file> <benign_freq_csv1> <malware_freq_csv2c>.\n");
        return 0;
    }
    char *opcode_file = argv[1];
    char *freq_csv1   = argv[2];
    char *freq_csv2   = argv[3];
    struct timeval start_seq, end_seq, diff_seq;
    /*
       STEPS in Main:
       1. Initialize everthing
       2. Read Opcode List
       3. Read .csv for malware and benign data base
       4. Normalize opcode frequencies of each file
       5. Group files in buckets of 5kb
       7. Do feature selection for each group
       8. Create training and testing datasets
    */


    int numopcode=0;
    int numfiles=0;
    s_trie *opcodelist = initTrie();
    s_files *filelist;
    s_group *grouplist;
    int *groupCount=NULL;
    initFiles(&filelist);
    initGroups(&grouplist, NUM_GROUPS);
    groupCount = createVector( NUM_GROUPS * NUM_CLASSES);

    numopcode = readOpcodeFile( opcode_file, &opcodelist);
    //reading csv files to get total no of files
    numfiles = readCSVFile( freq_csv1, numopcode, &filelist, groupCount);
    numfiles += readCSVFile( freq_csv2, numopcode, &filelist, groupCount);

    logShowFiles(filelist);
    normalizeOpcodeFrequency( &filelist);

    doGrouping( filelist, groupCount, &grouplist);
    logShowGroupWiseStats( grouplist, NUM_GROUPS);

    // selecting prominant features of each group
    selectFeaturesForEachGroup( &grouplist, NUM_GROUPS, numopcode, NUM_FEATURES);
    // Dumping group wise features
    logGroupWiseFeatures(grouplist, NUM_GROUPS, NUM_FEATURES, numopcode);
    int numtestfiles=numfiles;

    float *trainArray       = createFloatMatrix( NUM_GROUPS * 4, numopcode ); // MALWARE BENIGN MEAN VARIANCE  ... NUM_CLASSES * 2
    float *testArray        = createFloatMatrix( numtestfiles, numopcode );
    int   *train_class_vect = createVector( numtestfiles );
    int   *test_class_vect  = createVector( numtestfiles );
    int   *group_vect       = createVector( numtestfiles );
    // Seperating testing and trainning data
    // 1 file out of 10 files is taken out as testing data
    seperateTrainingAndTestingData(grouplist, NUM_GROUPS);
    //trainNaiveBayes(grouplist, NUM_GROUPS, numopcode, trainArray, train_class_vect);
    createTestingMatrix(grouplist, NUM_GROUPS, numopcode, testArray, test_class_vect, group_vect);

    //logSingleGroupData( grouplist, trainArray, NUM_GROUPS, numopcode, NUM_FEATURES, 45);
    //logTrainedMatrix( trainArray, NUM_GROUPS, numopcode);

    // Creating a featurelist (num_groups*(sizeof(int))
    int **featurelist = (int**) malloc(sizeof(int**));
    createFeatureListForEachGroup( &featurelist, NUM_GROUPS );

    //assigning features from each group to the feature and forming a  |g0.features|g1.features|.........
    assignFeatureListForEachGroup( &featurelist, grouplist, NUM_GROUPS);
    int   *h_featureMatrix;
    // Creating Feature Matrix. Here we are taking only top 20,40,60...... prominent features here we have take 20 but can be modified with the help of macro definition
    h_featureMatrix = createIntMatrix( NUM_GROUPS , NUM_FEATURES);
    spillFeatureMatrix( featurelist, h_featureMatrix, NUM_GROUPS, numopcode, NUM_FEATURES);

    free ( trainArray );
    free ( testArray );
    free ( test_class_vect );
    free ( train_class_vect );
    free ( group_vect );
    free ( h_featureMatrix );



    return 0;
}
