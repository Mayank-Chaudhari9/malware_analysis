#include <stdio.h>
#include <stdlib.h>
#include <string.h>

float* createFloatMatrix(
        int in_rows,      /*!< [in] number of rows in the matrix */
        int in_columns    /*!< [in] number of columns in the matrix */
        )
{
    float *temp = (float*) calloc( sizeof(float), in_columns*in_rows);
    return temp;
}


void read_trainning_matrix(char *filename, float *trainArray)
{
  char * line=NULL;
  size_t len =0;
  ssize_t read;
  FILE *fp = fopen(filename,"r");
  if (fp == NULL)
    exit(EXIT_FAILURE);
  read=getline(&line,&len,fp); //----->>uncomment  in case if we want to skip the first line providing group heading
  int column=0;
  while((read=getline(&line,&len,fp))!=-1)
  {
    //printf("Retrieved line of length : %zu \n",read ); //---->>uncomment to check how many chars we have read in each line to ensure we are reading data correctly
    //printf("%s", line);
    //icolumn=0;
    int row=0;
    char *value=strtok(line,",\n");
    //for(int row=0;row<12;row++)
    while (row<16)
    {
      //while (value !=NULL)
      if(value != NULL)
      {
        float fvalue;
        //int row=0;
        fvalue=strtof(value,NULL);

        printf("position : %d  ",row*5+column);
        trainArray[row*5+column]=fvalue;
        printf("%.5f\n",fvalue);
        row++;
        value=strtok(NULL,",\n");

      }
    }
    printf("\n");


    column++;
  }

}

void logTrainedMatrix(
    float *trainArray,
    int NUM_GROUPS,
    int numopcode
)
{
    char *filename = "./TrainedMatrix.log";
    FILE *fp=fopen(filename,"w");
    int i,j;
    printf("[ LOG ] Writing Trained Naive Bayes to file %s\n",filename);
        for( i=0; i<NUM_GROUPS; i++)
        {
            fprintf(fp,"G%dBM,G%dBV,G%dMM,G%dMV,",i,i,i,i);
        }
        fprintf(fp,"\n");
    for(j=0;j<numopcode;j++)
    {
        for( i=0; i<NUM_GROUPS*4; i++)
        {
            fprintf(fp,"%0.5f,",trainArray[i*numopcode+j]);
        }
        fprintf(fp,"\n");
    }
    fclose(fp);
}



int main(int argc, char **argv) {

  char *trainning_model =argv[1];

  if(argc<2)
    {
      printf("run with  ./t1 <trainning_model>\n");
      return 0;
    }
  //printf("%s\n", trainning_model)    // ----------- uncomment to check whether command line arguement is correct.

  // create datastructure for Trainning model (GROUP_NUM*4,NUM_OPCODES)
  float *trainArray = createFloatMatrix(4*4,5);

  // read values from csv file into trainArray;
  read_trainning_matrix(trainning_model,trainArray);

  //logging trainArray to varify whether our structure is correct or not
  /* verification steps
    1.> uncomment the logging function
    2.> compile and run code.
    3.> find diff between actual training model and the file generated by our logger.
  */
  //logTrainedMatrix(trainArray,4,5);


  return 0;
}
