#include "opcodeFile.h"
#include "trie.h"
#include "logger.h"
#include <assert.h>
#include <errno.h>
#include <limits.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#define MEAN 0
#define VAR 1
#define FREQUENCY 1
void logShowFiles(
        s_files * p_files
        )
{
    s_fileProp *temp = p_files->list;
    s_opcodenode *opcptr = NULL;
    int count = p_files->numFiles;
    printf("%d\n",count );
    char *filename = "../logs/DataSetFileDetails.log";
    FILE *fp=fopen(filename,"w");
    printf("[ LOG ] Writing frequency details of each file to %s\n",filename);
    while ( temp != NULL)
    {
        fprintf(fp,"\n%d %s %d\n", count--, temp->name, temp->numopcode);
        opcptr = temp->opcodes;
        int i=0;
        while( i<temp->numopcode)
        {
            fprintf(fp," %d=%d\t", opcptr[i].id, opcptr[i].freq);
            i++;
        }
        temp = temp->next;
    }
    fclose(fp);
}


void logShowGroupWiseStats(
        s_group * in_groups ,
        int in_num_groups
        )
{
    char *filename = "../logs/GroupwiseStats.log";
    FILE *fp=fopen(filename,"w");
    printf("[ LOG ] Writing Group wise Statistics to file%s\n",filename);
    int i,c;
    for( i=0; i< in_num_groups; i++)
    {
        fprintf(fp," Group %d, has %d files, max opcode count = %d, min opcode count = %d.\n", \
                i+1, in_groups[i].count, in_groups[i].max, in_groups[i].min);
        for( c=0 ; c<2; c++) // TODO make this genric NUM_CLASSES
        {
            fprintf(fp,"Group has %d files of Group %d ", c, in_groups[i].list[c].count);
            fprintf(fp,"\n");
        }
    }
    fclose(fp);
}
void logGroupWiseFeatures(
    s_group *in_groups,
    int in_num_groups,
    int in_num_features,
    int in_num_opcodes
)
{
    char *filename = "../logs/GroupWiseFeatures.log";
    FILE *fp=fopen(filename,"w");
    printf("[ LOG ] Writing Group wise prominent Features to file %s\n",filename);
    int i,f;
    for( i=0; i< in_num_groups; i++)
    {
        fprintf(fp," Group %d, has following prominent features:\n",i);
        for( f=0 ; f<in_num_opcodes; f++)
        {
            if( in_groups[i].features[f])
            fprintf(fp,"%d ", f);
        }
            fprintf(fp,"\n");
    }
    fclose(fp);
}
void logSingleGroupData( s_group *grouplist, float *trainArray, int NUM_GROUPS, int numopcode, int NUM_FEATURES, int group_num)
{
    char *filename = "../logs/GroupWiseTrainingAndTestingData.log";
    FILE *fp=fopen(filename,"w");
    printf("[ LOG ] Writing details for a Group(%d):prominent Features, training data, trained data to file %s\n", group_num, filename);
    int i;
    int o;
    int files_in_group=grouplist[group_num].trainlist.count;
    int rows = numopcode+1;
    int columns = (files_in_group*2)+5;
    float* buff = (float*)calloc(sizeof(float),rows*columns);
        s_filelistnode *file = grouplist[group_num].trainlist.list;
    for( o=0;o<numopcode;o++)
    {
        buff[ o*((files_in_group*2)+5)+0] = grouplist[group_num].features[o] ? o : 0;
        buff[ o*((files_in_group*2)+5)+1] = trainArray[(((group_num*4)+0)*numopcode)+o];
        buff[ o*((files_in_group*2)+5)+2] = trainArray[(((group_num*4)+1)*numopcode)+o];
        buff[ o*((files_in_group*2)+5)+3] = trainArray[(((group_num*4)+2)*numopcode)+o];
        buff[ o*((files_in_group*2)+5)+4] = trainArray[(((group_num*4)+3)*numopcode)+o];
    }

    for( i=0; i< grouplist[group_num].trainlist.count; i++)
    {
        for( o=0; o < file->prop->numopcode; o++)
        {
            int opcid=file->prop->opcodes[o].id;
            int freq=file->prop->opcodes[o].freq;
            float nor= file->prop->normalized_opcodes[o];
            buff[ opcid*((files_in_group*2)+5)+(5+(i*2)) ] = freq;
            buff[ opcid*((files_in_group*2)+5)+(5+(i*2)+1) ] = nor;
        }
        buff[ numopcode*((files_in_group*2)+5)+(5+(i*2))] = file->prop->classId;
        file=file->next;
    }

    for( i=0;i<rows;i++)
    {
        for(o=0;o<columns;o++)
        {
            fprintf(fp,"%0.5f,",buff[(i*columns)+o]);
        }
        fprintf(fp,"\n");
    }
    free(buff);
    fclose(fp);
}
void logTrainedMatrix(
    float *trainArray,
    int NUM_GROUPS,
    int numopcode
)
{
    char *filename = "../logs/TrainedMatrix.log";
    FILE *fp=fopen(filename,"w");
    int i,j;
    printf("[ LOG ] Writing Trained Naive Bayes to file %s\n",filename);
        for( i=0; i<NUM_GROUPS; i++)
        {
            fprintf(fp,"G%dBM,G%dBV,G%dMM,G%dMV,",i,i,i,i);
        }
        fprintf(fp,"\n");
    for(j=0;j<numopcode;j++)
    {
        for( i=0; i<NUM_GROUPS*4; i++)
        {
            fprintf(fp,"%0.5f,",trainArray[i*numopcode+j]);
        }
        fprintf(fp,"\n");
    }
    fclose(fp);
}


void logFeatureMatrix(int num_groups,int num_features, int *in_featureMatrix)
{

    //printf("%d\n",*in_featureMatrix );
    char *filename =  "../logs/FeatureMatrix.log";
    FILE *fp = fopen(filename,"w");
    int row,column;
    printf("[LOG] Writing FeatureMatrix to file %s \n",filename );
    for (row=0;row<num_groups;row++)
      {
        fprintf(fp,"G%d,",row);
      }
    fprintf(fp,"\n");

    for(column=0;column<num_features;column++)
    {
        for(row=0;row<num_groups;row++)
        {
            fprintf(fp, "%d,",in_featureMatrix[row*num_features+column] );
        }
        fprintf(fp, "\n");
    }
    fclose(fp);
}


void logTestingData(
    float *testArray,
    int *group_vect,
    int *test_class_vect,
    int *predict_class_vect,
    int numopcode,
    int numtestfiles,
    int group_num
)
{
    char *filename = "../logs/TestingData.log";
    FILE *fp=fopen(filename,"w");
    int i,j,numcolumns=0,rows=0,in=0;
    printf("[ LOG ] Writing Testing Data(class,normalized frequencies,predicted class of each file) of group(%d) to file %s\n",group_num, filename);
    for( i=0; i<numtestfiles; i++)
        if( group_num == group_vect[i] ) numcolumns++;
    rows=numopcode+2;
    float *buff = (float*) calloc( sizeof(float), rows*numcolumns);
    for( i=0; i<numtestfiles; i++)
    {
        if( group_num != group_vect[i] ) continue;
        in++;
        buff[(0*numcolumns)+in] = test_class_vect[i];
        for( j=1;j<(numopcode+1);j++)
        {
            buff[(j*numcolumns)+in] = testArray[(i*numopcode)+(j-1)];
        }
        buff[((numopcode+1)*numcolumns)+in] = predict_class_vect[i];
    }
    for ( i=0;i<rows;i++)
    {
        for( j=0;j<numcolumns;j++)
        {
            fprintf(fp,"%0.5f,",buff[i*numcolumns+j]);
        }
        fprintf(fp,"\n");
    }
    free(buff);
    fclose(fp);
}
void logTimingData(int numfiles, float paralleltime, float sequentialTime, float acc)
{
    FILE *fp=NULL;
    char *filename = "../logs/TimingData.log";
    if ( numfiles == 0 && paralleltime == 0.0f && sequentialTime ==0.0f && acc == 0.0f)
    {
        fp=fopen(filename,"w");
        printf("[ LOG ] Writing Timing Data to file %s\n",filename);
    }
    else
    {
        FILE *fp = fopen(filename,"a");
        fprintf(fp,"%d\t%f\t%f\t%f\n",numfiles, paralleltime, sequentialTime, acc);
    }
    if( fp)    fclose(fp);
}
